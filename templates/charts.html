{% extends "base.html" %}

{% block head %}{% endblock %}

{% block content %}
<div class="card shadow-sm border-0 mb-3">
  <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2">
    <h1 class="h4 mb-0">Graphics</h1>
    <span class="badge text-bg-secondary">Live DB data</span>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="fw-semibold mb-2">Foods per Annex III category</div>
        <div id="food-category-chart" class="chart-box"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="fw-semibold mb-2">Simulant coverage across categories</div>
        <div id="simulant-chart" class="chart-box"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    const foodsPerCategory = {{ foods_per_category | tojson }};
    const simulantsPerCategory = {{ simulants_per_category | tojson }};

    google.charts.load('current', { packages: ['corechart', 'table'] });
    google.charts.setOnLoadCallback(() => {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', drawCharts, { once: true });
      } else {
        drawCharts();
      }
    });

    function drawCharts() {
      drawFoodCategoryChart();
      drawSimulantChart();
    }

    function drawFoodCategoryChart() {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Category');
      data.addColumn('number', 'Foods');
      data.addColumn({ type: 'string', role: 'tooltip' });

      const rows = foodsPerCategory.map(({ ref_no: refNo, description, total, frf }) => {
        const tooltip = `${description} (FRF: ${frf ?? 'n/a'})`;
        return [refNo, Number(total), tooltip];
      });

      data.addRows(rows);
      const options = {
        title: 'Foods per Annex III category',
        legend: { position: 'none' },
        chartArea: { width: '80%', height: '70%' },
        hAxis: { title: 'Category' },
        vAxis: { title: 'Foods' },
      };
      const el = document.getElementById('food-category-chart');
      if (el) {
        const chart = new google.visualization.ColumnChart(el);
        chart.draw(data, options);
      }
    }

    function drawSimulantChart() {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Simulant');
      data.addColumn('number', 'Linked categories');

      const rows = simulantsPerCategory.map(({ abbreviation, total }) => [abbreviation, Number(total)]);
      data.addRows(rows);
      const options = {
        title: 'Simulant coverage across categories',
        legend: { position: 'none' },
        chartArea: { width: '80%', height: '70%' },
        colors: ['#1366d6'],
      };
      const el = document.getElementById('simulant-chart');
      if (el) {
        const chart = new google.visualization.BarChart(el);
        chart.draw(data, options);
      }
    }
  </script>
{% endblock %}
