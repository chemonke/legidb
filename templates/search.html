{% extends "base.html" %}

{% block content %}
<section class="section">
  <div class="section-header">
    <h1>Search substances</h1>
    <p>Look up authorised substances by CAS number or substance name/identifier. Food categories are not part of this search.</p>
  </div>
  <form class="search-form" method="get">
    <input type="text" name="q" placeholder="Search by CAS number or substance name (e.g. 67-64-1)" value="{{ query }}">
    <button type="submit">Search</button>
  </form>

  {% if query and not substances %}
    <p class="muted">No matches for "{{ query }}". Try a different term.</p>
  {% endif %}

  {% if substances %}
    <table class="data-table">
      <thead>
        <tr>
          <th>CAS number</th>
          <th>Name / identifier</th>
          <th>Identifiers</th>
          <th>Limits & notes</th>
        </tr>
      </thead>
      <tbody>
        {% for substance in substances %}
          <tr>
            <td>{{ substance.cas_no or "—" }}</td>
            <td>{{ substance.smiles or "—" }}</td>
            <td>
              <div>FCM No: {{ substance.fcm_no or "—" }}</div>
              <div>EC Ref No: {{ substance.ec_ref_no or "—" }}</div>
            </td>
            <td>
              {% if substance.sm_entries %}
                {% for entry in substance.sm_entries %}
                  <div class="limit-block">
                    {% if entry.limits %}
                      {% for limit in entry.limits %}
                        <span class="pill tight">{{ limit.kind.value }}
                          {% if limit.value is not none %}
                            {{ "%.3f"|format(limit.value) }}
                          {% elif limit.raw_expression %}
                            {{ limit.raw_expression }}
                          {% endif %}
                        </span>
                      {% endfor %}
                    {% else %}
                      <span class="muted">No SML recorded.</span>
                    {% endif %}
                    {% if entry.restrictions_and_specifications %}
                      <div class="muted">{{ entry.restrictions_and_specifications }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <span class="muted">No Annex I entry stored for this substance.</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</section>
{% endblock %}
